---
- name: Validate required secret variables are defined and non-empty
  ansible.builtin.assert:
    that:
      - vars[item.value.var] is defined
      - vars[item.value.var] | trim | length > 0
    fail_msg: >
      Docker secret '{{ item.key }}' is enabled but required Ansible variable
      '{{ item.value.var }}' is missing or empty.
  loop: "{{ docker_secrets | dict2items }}"
  loop_control:
    label: "{{ item.key }}"
  when: item.value.enabled | bool

- name: Ensure secrets directory exists
  ansible.builtin.file:
    path: "{{ docker_tooling_dir }}/secrets"
    state: directory
    owner: "{{ docker_tooling_user }}"
    group: "{{ docker_tooling_group }}"
    mode: '0700'

- name: Write secrets to disk (authoritative)
  ansible.builtin.copy:
    dest: "{{ docker_tooling_dir }}/secrets/{{ item.key }}"
    content: "{{ vars[item.value.var] }}"
    owner: "{{ docker_tooling_user }}"
    group: "{{ docker_tooling_group }}"
    mode: '0600'
  loop: "{{ docker_secrets | dict2items }}"
  loop_control:
    label: "{{ item.key }}"
  when: item.value.enabled | bool

- name: Remove disabled secrets from disk
  ansible.builtin.file:
    path: "{{ docker_tooling_dir }}/secrets/{{ item.key }}"
    state: absent
  loop: "{{ docker_secrets | dict2items }}"
  loop_control:
    label: "{{ item.key }}"
  when: not item.value.enabled | bool
