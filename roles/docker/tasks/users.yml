---
- name: Load common user metadata from remote host
  slurp:
    src: /etc/ansible/common_users.yml
  register: common_users_file

- name: Parse remote YAML into a variable
  set_fact:
    common_users_metadata: "{{ common_users_file.content | b64decode | from_yaml }}"

- name: Validate common_users metadata structure
  assert:
    that:
      - common_users_metadata.common_users is defined
      - common_users_metadata.common_users is iterable
    fail_msg: "/etc/ansible/common_users.yml must define a top-level 'common_users' list."

- name: Prepare docker users for upstream
  set_fact:
    upstream_docker_users: >-
      {{
        common_users_metadata.common_users
        | selectattr('tags', 'defined')
        | selectattr('tags', 'contains', 'docker')
        | map(attribute='name')
        | list
      }}

- name: Ensure docker group exists
  group:
    name: docker
    state: present

- name: Add tagged users to docker group
  user:
    name: "{{ item }}"
    groups: docker
    append: true
  loop: "{{ upstream_docker_users }}"
  when: upstream_docker_users | length > 0
